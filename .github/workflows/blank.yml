name: 

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - uses: actions/checkout@v4

      # Set up Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
            terraform_version: 1.6.0

      # Validate Terraform formatting
      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      # Initialize Terraform (necesario para validar y otras operaciones)
      - name: Terraform Init
        run: terraform init

      # Validate Terraform configuration
      - name: Terraform Validate
        run: terraform validate

      # Install Terrascan
      - name: Install Terrascan
        run: |
          curl -L https://github.com/accurics/terrascan/releases/latest/download/terrascan-linux-amd64 -o terrascan
          echo "Verifying Terrascan binary..."
          file terrascan
          chmod +x terrascan
          sudo mv terrascan /usr/local/bin/

      # Initialize Terrascan
      - name: Terrascan Init
        run: terrascan init

      # Run Terrascan for security checks
      - name: Terrascan Security Scan
        uses: accurics/terrascan-action@v1
